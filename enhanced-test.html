<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Test Mode - MIS245 Exam 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.179.1/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.waves.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .vanta-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .question-card { transition: all 0.3s ease; }
        .option-button { transition: all 0.2s ease; }
        .option-button:hover { transform: translateY(-1px); }
        .option-selected { background: #3b82f6; color: white; border-color: #3b82f6; }
        .option-correct { background: #10b981; color: white; border-color: #10b981; }
        .option-incorrect { background: #ef4444; color: white; border-color: #ef4444; }
        .option-disabled { opacity: 0.6; cursor: not-allowed; }
        .feedback-visible { max-height: 400px; opacity: 1; transition: all 0.5s ease; }
        .feedback-hidden { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s ease; }
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
        .progress-bar { transition: width 0.3s ease; }
        .pulse-correct { animation: pulse-correct 1s ease-in-out; }
        .pulse-incorrect { animation: pulse-incorrect 1s ease-in-out; }
        @keyframes pulse-correct { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); } }
        @keyframes pulse-incorrect { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); } }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-cyan-50">
    <div id="vanta-bg"></div>
    
    <!-- Navigation -->
    <nav class="relative z-10 glass-effect border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="flex items-center space-x-3">
                        <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
                        <h1 class="text-xl font-bold text-gray-800">MIS245 Study Guide</h1>
                    </a>
                </div>
                <div class="flex space-x-6">
                    <a href="study.html" class="text-gray-700 hover:text-blue-600 font-medium transition-colors">Study Mode</a>
                    <a href="enhanced-test.html" class="text-blue-600 font-medium">Test Mode</a>
                    <a href="progress.html" class="text-gray-700 hover:text-blue-600 font-medium transition-colors">Progress</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Test Setup -->
    <section id="testSetup" class="relative z-10 pt-16 pb-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="glass-effect rounded-2xl p-8 text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-tasks text-blue-600 mr-3"></i>
                    Enhanced Test Mode
                </h1>
                <p class="text-lg text-gray-600 mb-8">
                    Take a challenging test with immediate feedback after each question. 
                    Get detailed explanations and learn as you go!
                </p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <!-- Chapter Selection -->
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Chapters</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter5" checked>
                                <span class="ml-2 text-sm">Chapter 5 - IT Infrastructure</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter6" checked>
                                <span class="ml-2 text-sm">Chapter 6 - Databases</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter7" checked>
                                <span class="ml-2 text-sm">Chapter 7 - Networks</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter8" checked>
                                <span class="ml-2 text-sm">Chapter 8 - Security</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Question Count -->
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Number of Questions</label>
                        <select id="questionCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="10">10 Questions</option>
                            <option value="15" selected>15 Questions</option>
                            <option value="20">20 Questions</option>
                            <option value="24">All Questions (24)</option>
                        </select>
                    </div>
                    
                    <!-- Difficulty Level -->
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Difficulty Focus</label>
                        <select id="difficultyFocus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="mixed" selected>Mixed Difficulty</option>
                            <option value="hard">Challenging Questions</option>
                            <option value="medium">Moderate Questions</option>
                            <option value="easy">Basic Questions</option>
                        </select>
                    </div>
                </div>
                
                <button id="startTestBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold text-lg transition-all">
                    <i class="fas fa-play mr-2"></i>
                    Start Test
                </button>
            </div>
        </div>
    </section>

    <!-- Test Interface -->
    <section id="testInterface" class="relative z-10 pt-16 pb-8 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Test Header -->
            <div class="glass-effect rounded-2xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Test in Progress</h2>
                        <p class="text-gray-600">Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">15</span></p>
                    </div>
                    
                    <!-- Score Display -->
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600" id="currentScore">0</div>
                        <div class="text-sm text-gray-600">Score</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 6.67%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Question Card -->
            <div id="questionCard" class="glass-effect rounded-2xl p-8 question-card">
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <span id="questionChapter" class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                            Chapter 5
                        </span>
                        <span id="questionDifficulty" class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">
                            Hard
                        </span>
                        <span id="questionType" class="text-xs font-semibold px-2 py-1 rounded-full bg-purple-100 text-purple-800">
                            Scenario Analysis
                        </span>
                    </div>
                    <h3 id="questionText" class="text-xl font-semibold text-gray-800 leading-relaxed">
                        Question text will appear here...
                    </h3>
                </div>
                
                <!-- Multiple Choice Options -->
                <div id="optionsContainer" class="space-y-3">
                    <!-- Options will be loaded here -->
                </div>
                
                <!-- Submit Button -->
                <div class="mt-8 text-center">
                    <button id="submitBtn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold text-lg transition-all opacity-50 cursor-not-allowed" disabled>
                        <i class="fas fa-check mr-2"></i>
                        Submit Answer
                    </button>
                </div>
                
                <!-- Feedback Section -->
                <div id="feedbackSection" class="feedback-hidden mt-6 p-6 bg-white/50 rounded-xl">
                    <div id="feedbackContent">
                        <!-- Feedback content will be loaded here -->
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button id="nextQuestionBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                            <i class="fas fa-arrow-right mr-2"></i>
                            Next Question
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Test Results -->
    <section id="testResults" class="relative z-10 pt-16 pb-8 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="glass-effect rounded-2xl p-8 text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-trophy text-yellow-500 mr-3"></i>
                    Test Complete!
                </h1>
                
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Score Display -->
                    <div class="bg-white/50 rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Your Score</h3>
                        <div class="text-6xl font-bold text-blue-600 mb-2" id="finalScore">85%</div>
                        <p class="text-gray-600">
                            <span id="correctAnswers">13</span> out of <span id="totalAnswers">15</span> correct
                        </p>
                        <div class="mt-4">
                            <div class="text-2xl font-bold" id="letterGrade">B+</div>
                            <div class="text-sm text-gray-600">Grade</div>
                        </div>
                    </div>
                    
                    <!-- Performance Summary -->
                    <div class="bg-white/50 rounded-xl p-6 text-left">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Performance Summary</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Time Taken:</span>
                                <span class="font-semibold" id="timeTaken">12:45</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average per Question:</span>
                                <span class="font-semibold" id="avgTimePerQuestion">0:51</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Difficulty Level:</span>
                                <span class="font-semibold text-purple-600" id="difficultyLevel">Challenging</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Improvement:</span>
                                <span class="font-semibold text-green-600" id="improvement">+12% from last test</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chapter Breakdown -->
                <div class="bg-white/50 rounded-xl p-6 mb-8 text-left">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Chapter Performance</h3>
                    <div id="chapterBreakdown" class="space-y-3">
                        <!-- Chapter breakdown will be loaded here -->
                    </div>
                </div>
                
                <!-- Detailed Review Section -->
                <div class="bg-white/50 rounded-xl p-6 mb-8 text-left">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Question Review</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        <i class="fas fa-info-circle mr-2"></i>
                        Review the questions you got wrong to improve your understanding
                    </div>
                    <div id="questionReview" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Question review will be loaded here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="retakeTestBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-redo mr-2"></i>
                        Retake Test
                    </button>
                    <button id="newTestBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        New Test
                    </button>
                    <button id="studyModeBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-book-open mr-2"></i>
                        Study Mode
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="relative z-10 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-600">&copy; 2025 MIS245 Study Guide. Built for success.</p>
        </div>
    </footer>

    <script src="enhanced-questions.js"></script>
    <script>
        // Initialize Vanta.js background
        VANTA.WAVES({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0x3b82f6,
            shininess: 30.00,
            waveHeight: 15.00,
            waveSpeed: 0.75,
            zoom: 0.75
        });

        // Test state
        let testQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let correctAnswers = 0;
        let testStartTime = null;
        let questionStartTime = null;
        let questionTimes = [];
        let selectedOption = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('startTestBtn').addEventListener('click', startTest);
            document.getElementById('submitBtn').addEventListener('click', submitAnswer);
            document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
            document.getElementById('retakeTestBtn').addEventListener('click', retakeTest);
            document.getElementById('newTestBtn').addEventListener('click', newTest);
            document.getElementById('studyModeBtn').addEventListener('click', () => window.location.href = 'study.html');
        }

        function startTest() {
            // Get selected chapters
            const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedChapters.length === 0) {
                alert('Please select at least one chapter.');
                return;
            }

            // Get test settings
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const difficultyFocus = document.getElementById('difficultyFocus').value;

            // Prepare test questions
            prepareTestQuestions(selectedChapters, questionCount, difficultyFocus);
            
            // Initialize test state
            currentQuestionIndex = 0;
            userAnswers = new Array(testQuestions.length).fill(null);
            correctAnswers = 0;
            testStartTime = Date.now();
            questionTimes = [];

            // Show test interface
            document.getElementById('testSetup').classList.add('hidden');
            document.getElementById('testInterface').classList.remove('hidden');

            // Load first question
            loadQuestion();
        }

        function prepareTestQuestions(chapters, count, difficultyFocus) {
            let allQuestions = [];
            
            // Get questions from selected chapters
            chapters.forEach(chapter => {
                const chapterQuestions = getEnhancedQuestionsByChapter(chapter);
                allQuestions = allQuestions.concat(chapterQuestions.map(q => ({
                    ...q,
                    chapter: chapter,
                    chapterTitle: enhancedQuestions[chapter].title
                })));
            });

            // Filter by difficulty if specified
            if (difficultyFocus !== 'mixed') {
                allQuestions = allQuestions.filter(q => q.difficulty === difficultyFocus);
            }

            // Shuffle questions
            allQuestions = shuffleArray(allQuestions);
            
            // Select the requested number of questions
            testQuestions = allQuestions.slice(0, Math.min(count, allQuestions.length));
        }

        function loadQuestion() {
            const question = testQuestions[currentQuestionIndex];
            questionStartTime = Date.now();
            selectedOption = null;
            
            // Update question info
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = testQuestions.length;
            document.getElementById('currentScore').textContent = correctAnswers;
            document.getElementById('questionChapter').textContent = question.chapter.replace('chapter', 'Chapter ');
            document.getElementById('questionDifficulty').textContent = 
                question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);
            document.getElementById('questionDifficulty').className = 
                `text-xs font-semibold px-2 py-1 rounded-full ${getDifficultyColor(question.difficulty)}`;
            document.getElementById('questionType').textContent = 
                question.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('questionText').textContent = question.question;
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / testQuestions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Generate multiple choice options
            generateOptions(question);
            
            // Reset UI state
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('feedbackSection').classList.remove('feedback-visible');
            document.getElementById('feedbackSection').classList.add('feedback-hidden');
        }

        function generateOptions(question) {
            const container = document.getElementById('optionsContainer');
            
            // Create option buttons
            container.innerHTML = question.options.map((option, index) => `
                <button class="option-button w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all" 
                        data-option="${option}" onclick="selectOption('${option}', this)">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 text-sm font-semibold">
                            ${String.fromCharCode(65 + index)}
                        </div>
                        <span class="flex-1">${option}</span>
                    </div>
                </button>
            `).join('');
        }

        function selectOption(option, buttonElement) {
            // Clear previous selection
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('option-selected');
            });
            
            // Select new option
            buttonElement.classList.add('option-selected');
            selectedOption = option;
            
            // Enable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function submitAnswer() {
            if (!selectedOption) return;
            
            const question = testQuestions[currentQuestionIndex];
            const isCorrect = selectedOption === question.correctAnswer;
            
            // Record answer and timing
            userAnswers[currentQuestionIndex] = {
                selected: selectedOption,
                correct: isCorrect,
                question: question
            };
            
            questionTimes.push(Date.now() - questionStartTime);
            
            if (isCorrect) {
                correctAnswers++;
            }
            
            // Update score display
            document.getElementById('currentScore').textContent = correctAnswers;
            
            // Disable all option buttons
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.add('option-disabled');
                btn.onclick = null;
            });
            
            // Show correct/incorrect styling
            document.querySelectorAll('.option-button').forEach(btn => {
                const optionText = btn.getAttribute('data-option');
                if (optionText === question.correctAnswer) {
                    btn.classList.add('option-correct');
                    btn.classList.add('pulse-correct');
                } else if (optionText === selectedOption && !isCorrect) {
                    btn.classList.add('option-incorrect');
                    btn.classList.add('pulse-incorrect');
                }
            });
            
            // Hide submit button
            document.getElementById('submitBtn').style.display = 'none';
            
            // Show feedback
            showFeedback(question, isCorrect);
        }

        function showFeedback(question, isCorrect) {
            const feedbackSection = document.getElementById('feedbackSection');
            const feedbackContent = document.getElementById('feedbackContent');
            
            const feedbackIcon = isCorrect ? 'fas fa-check-circle text-green-500' : 'fas fa-times-circle text-red-500';
            const feedbackTitle = isCorrect ? 'Correct!' : 'Incorrect';
            const feedbackColor = isCorrect ? 'text-green-600' : 'text-red-600';
            
            feedbackContent.innerHTML = `
                <div class="flex items-start mb-4">
                    <i class="${feedbackIcon} text-2xl mr-3 mt-1"></i>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold ${feedbackColor} mb-2">${feedbackTitle}</h4>
                        <div class="mb-4">
                            <div class="font-semibold text-gray-800 mb-2">Correct Answer:</div>
                            <div class="text-gray-700 p-3 bg-gray-100 rounded-lg">${question.correctAnswer}</div>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800 mb-2">Explanation:</div>
                            <div class="text-gray-700 leading-relaxed">${question.explanation}</div>
                        </div>
                    </div>
                </div>
            `;
            
            feedbackSection.classList.remove('feedback-hidden');
            feedbackSection.classList.add('feedback-visible');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= testQuestions.length) {
                finishTest();
            } else {
                loadQuestion();
            }
        }

        function finishTest() {
            // Calculate final results
            const totalTime = Date.now() - testStartTime;
            const avgTime = questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length;
            const score = Math.round((correctAnswers / testQuestions.length) * 100);
            
            // Display results
            displayResults({
                score,
                correctCount: correctAnswers,
                totalQuestions: testQuestions.length,
                timeTaken: totalTime,
                avgTimePerQuestion: avgTime,
                userAnswers: userAnswers,
                testQuestions: testQuestions
            });
            
            // Show results interface
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('testResults').classList.remove('hidden');
        }

        function displayResults(results) {
            document.getElementById('finalScore').textContent = `${results.score}%`;
            document.getElementById('correctAnswers').textContent = results.correctCount;
            document.getElementById('totalAnswers').textContent = results.totalQuestions;
            
            const minutes = Math.floor(results.timeTaken / 60000);
            const seconds = Math.floor((results.timeTaken % 60000) / 1000);
            document.getElementById('timeTaken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const avgMinutes = Math.floor(results.avgTimePerQuestion / 60000);
            const avgSeconds = Math.floor((results.avgTimePerQuestion % 60000) / 1000);
            document.getElementById('avgTimePerQuestion').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            const letterGrade = getLetterGrade(results.score);
            document.getElementById('letterGrade').textContent = letterGrade;
            
            // Display chapter breakdown
            displayChapterBreakdown(results.userAnswers, results.testQuestions);
            
            // Display question review
            displayQuestionReview(results.userAnswers, results.testQuestions);
        }

        function displayChapterBreakdown(userAnswers, testQuestions) {
            const chapterStats = {};
            
            // Calculate chapter statistics
            testQuestions.forEach((question, index) => {
                const chapter = question.chapter;
                if (!chapterStats[chapter]) {
                    chapterStats[chapter] = { total: 0, correct: 0 };
                }
                
                chapterStats[chapter].total++;
                if (userAnswers[index].correct) {
                    chapterStats[chapter].correct++;
                }
            });
            
            const breakdownContainer = document.getElementById('chapterBreakdown');
            breakdownContainer.innerHTML = Object.entries(chapterStats).map(([chapter, stats]) => {
                const percentage = Math.round((stats.correct / stats.total) * 100);
                const chapterName = enhancedQuestions[chapter].title.split(':')[0];
                const colorClass = percentage >= 80 ? 'bg-green-500' : percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                
                return `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">${chapterName}:</span>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold">${stats.correct}/${stats.total} (${percentage}%)</span>
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="${colorClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayQuestionReview(userAnswers, testQuestions) {
            const reviewContainer = document.getElementById('questionReview');
            
            // Only show incorrect answers for review
            const incorrectAnswers = userAnswers.map((answer, index) => ({
                ...answer,
                index: index,
                question: testQuestions[index]
            })).filter(answer => !answer.correct);
            
            if (incorrectAnswers.length === 0) {
                reviewContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-trophy text-4xl text-yellow-500 mb-4"></i>
                        <h4 class="text-xl font-bold text-green-600 mb-2">Perfect Score!</h4>
                        <p class="text-gray-600">You answered all questions correctly. Great job!</p>
                    </div>
                `;
                return;
            }
            
            reviewContainer.innerHTML = incorrectAnswers.map(item => `
                <div class="p-4 bg-red-50 rounded-lg border-l-4 border-red-400">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-800">
                                Question ${item.index + 1}
                            </span>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                ${item.question.chapter.replace('chapter', 'Chapter ')}
                            </span>
                        </div>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">
                            ${item.question.difficulty.charAt(0).toUpperCase() + item.question.difficulty.slice(1)}
                        </span>
                    </div>
                    
                    <h4 class="font-semibold text-gray-800 mb-2">${item.question.question}</h4>
                    
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-semibold text-red-600">Your Answer:</span>
                            <span class="text-gray-700">${item.selected}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-green-600">Correct Answer:</span>
                            <span class="text-gray-700">${item.question.correctAnswer}</span>
                        </div>
                        <div class="mt-2 p-2 bg-gray-100 rounded">
                            <span class="font-semibold text-gray-800">Explanation:</span>
                            <p class="text-gray-600 mt-1">${item.question.explanation}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getLetterGrade(score) {
            if (score >= 97) return 'A+';
            if (score >= 93) return 'A';
            if (score >= 90) return 'A-';
            if (score >= 87) return 'B+';
            if (score >= 83) return 'B';
            if (score >= 80) return 'B-';
            if (score >= 77) return 'C+';
            if (score >= 73) return 'C';
            if (score >= 70) return 'C-';
            if (score >= 67) return 'D+';
            if (score >= 63) return 'D';
            return 'F';
        }

        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case 'easy': return 'bg-green-100 text-green-800';
                case 'medium': return 'bg-yellow-100 text-yellow-800';
                case 'hard': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function retakeTest() {
            // Reset and start test with same settings
            document.getElementById('testResults').classList.add('hidden');
            startTest();
        }

        function newTest() {
            // Go back to test setup
            document.getElementById('testResults').classList.add('hidden');
            document.getElementById('testSetup').classList.remove('hidden');
        }
    </script>
<script>
    document.addEventListener('keydown', e => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            e.preventDefault();
        }
    });
</script>
</body>
</html>
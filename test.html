<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mode - MIS245 Exam 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.179.1/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.waves.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .vanta-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .question-card { transition: all 0.3s ease; }
        .option-button { transition: all 0.2s ease; }
        .option-button:hover { transform: translateY(-1px); }
        .option-selected { background: #3b82f6; color: white; }
        .option-correct { background: #10b981; color: white; }
        .option-incorrect { background: #ef4444; color: white; }
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-cyan-50">
    <div id="vanta-bg"></div>
    
    <!-- Navigation -->
    <nav class="relative z-10 glass-effect border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="flex items-center space-x-3">
                        <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
                        <h1 class="text-xl font-bold text-gray-800">MIS245 Study Guide</h1>
                    </a>
                </div>
                <div class="flex space-x-6">
                    <a href="study.html" class="text-gray-700 hover:text-blue-600 font-medium transition-colors">Study Mode</a>
                    <a href="test.html" class="text-blue-600 font-medium">Test Mode</a>
                    <a href="progress.html" class="text-gray-700 hover:text-blue-600 font-medium transition-colors">Progress</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Test Setup -->
    <section id="testSetup" class="relative z-10 pt-16 pb-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="glass-effect rounded-2xl p-8 text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-tasks text-blue-600 mr-3"></i>
                    Test Mode
                </h1>
                <p class="text-lg text-gray-600 mb-8">
                    Take a timed test with randomized questions. Choose your preferences below.
                </p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <!-- Chapter Selection -->
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Chapters</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter5" checked>
                                <span class="ml-2 text-sm">Chapter 5 - IT Infrastructure</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter6" checked>
                                <span class="ml-2 text-sm">Chapter 6 - Databases</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter7" checked>
                                <span class="ml-2 text-sm">Chapter 7 - Networks</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="chapter-checkbox rounded text-blue-600" value="chapter8" checked>
                                <span class="ml-2 text-sm">Chapter 8 - Security</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Question Count -->
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Number of Questions</label>
                        <select id="questionCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="10">10 Questions</option>
                            <option value="20" selected>20 Questions</option>
                            <option value="30">30 Questions</option>
                            <option value="48">All Questions (48)</option>
                        </select>
                    </div>
                    
                    <!-- Time Limit -->
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Time Limit</label>
                        <select id="timeLimit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="0">No limit</option>
                        </select>
                    </div>
                </div>
                
                <button id="startTestBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold text-lg transition-all">
                    <i class="fas fa-play mr-2"></i>
                    Start Test
                </button>
            </div>
        </div>
    </section>

    <!-- Test Interface -->
    <section id="testInterface" class="relative z-10 pt-16 pb-8 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Test Header -->
            <div class="glass-effect rounded-2xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Test in Progress</h2>
                        <p class="text-gray-600">Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">20</span></p>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="flex items-center space-x-4">
                        <div class="relative w-16 h-16">
                            <svg class="w-16 h-16 transform -rotate-90">
                                <circle cx="32" cy="32" r="28" stroke="#e5e7eb" stroke-width="4" fill="none"/>
                                <circle id="timerRing" cx="32" cy="32" r="28" stroke="#3b82f6" stroke-width="4" fill="none" class="timer-ring"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="timeRemaining" class="text-lg font-bold text-gray-800">30:00</span>
                            </div>
                        </div>
                        <button id="pauseBtn" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">
                            <i class="fas fa-pause mr-1"></i>
                            Pause
                        </button>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 5%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Question Card -->
            <div id="questionCard" class="glass-effect rounded-2xl p-8 question-card">
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <span id="questionChapter" class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                            Chapter 5
                        </span>
                        <span id="questionDifficulty" class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">
                            Medium
                        </span>
                    </div>
                    <h3 id="questionText" class="text-xl font-semibold text-gray-800 leading-relaxed">
                        Question text will appear here...
                    </h3>
                </div>
                
                <!-- Multiple Choice Options -->
                <div id="optionsContainer" class="space-y-3">
                    <!-- Options will be loaded here -->
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between items-center mt-8">
                    <button id="prevBtn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-chevron-left mr-2"></i>
                        Previous
                    </button>
                    
                    <div class="flex space-x-4">
                        <button id="flagBtn" class="px-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-colors">
                            <i class="fas fa-flag mr-2"></i>
                            Flag Question
                        </button>
                        <button id="nextBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                            Next
                            <i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Test Results -->
    <section id="testResults" class="relative z-10 pt-16 pb-8 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="glass-effect rounded-2xl p-8 text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-trophy text-yellow-500 mr-3"></i>
                    Test Complete!
                </h1>
                
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Score Display -->
                    <div class="bg-white/50 rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Your Score</h3>
                        <div class="text-6xl font-bold text-blue-600 mb-2" id="finalScore">85%</div>
                        <p class="text-gray-600">
                            <span id="correctAnswers">17</span> out of <span id="totalAnswers">20</span> correct
                        </p>
                    </div>
                    
                    <!-- Performance Summary -->
                    <div class="bg-white/50 rounded-xl p-6 text-left">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Performance Summary</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Time Taken:</span>
                                <span class="font-semibold" id="timeTaken">24:35</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Questions Flagged:</span>
                                <span class="font-semibold" id="questionsFlagged">3</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average Time per Question:</span>
                                <span class="font-semibold" id="avgTimePerQuestion">1:14</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Grade:</span>
                                <span class="font-semibold text-green-600" id="letterGrade">B+</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chapter Breakdown -->
                <div class="bg-white/50 rounded-xl p-6 mb-8 text-left">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Chapter Performance</h3>
                    <div id="chapterBreakdown" class="space-y-3">
                        <!-- Chapter breakdown will be loaded here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="reviewAnswersBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-eye mr-2"></i>
                        Review Answers
                    </button>
                    <button id="retakeTestBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-redo mr-2"></i>
                        Retake Test
                    </button>
                    <button id="newTestBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        New Test
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Review Answers -->
    <section id="reviewSection" class="relative z-10 pt-16 pb-8 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="glass-effect rounded-2xl p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                    <i class="fas fa-eye text-blue-600 mr-3"></i>
                    Review Your Answers
                </h2>
                
                <div id="reviewContainer" class="space-y-6">
                    <!-- Review questions will be loaded here -->
                </div>
                
                <div class="text-center mt-8">
                    <button id="backToResultsBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Results
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="relative z-10 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-600">&copy; 2025 MIS245 Study Guide. Built for success.</p>
        </div>
    </footer>

    <script src="questions.js"></script>
    <script>
        // Initialize Vanta.js background
        VANTA.WAVES({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0x3b82f6,
            shininess: 30.00,
            waveHeight: 15.00,
            waveSpeed: 0.75,
            zoom: 0.75
        });

        // Test state
        let testQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let flaggedQuestions = [];
        let testStartTime = null;
        let testTimer = null;
        let timeRemaining = 0;
        let isPaused = false;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('startTestBtn').addEventListener('click', startTest);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('prevBtn').addEventListener('click', () => navigateQuestion(-1));
            document.getElementById('nextBtn').addEventListener('click', () => navigateQuestion(1));
            document.getElementById('flagBtn').addEventListener('click', toggleFlag);
            document.getElementById('reviewAnswersBtn').addEventListener('click', reviewAnswers);
            document.getElementById('retakeTestBtn').addEventListener('click', retakeTest);
            document.getElementById('newTestBtn').addEventListener('click', newTest);
            document.getElementById('backToResultsBtn').addEventListener('click', backToResults);
        }

        function startTest() {
            // Get selected chapters
            const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedChapters.length === 0) {
                alert('Please select at least one chapter.');
                return;
            }

            // Get test settings
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const timeLimit = parseInt(document.getElementById('timeLimit').value);

            // Prepare test questions
            prepareTestQuestions(selectedChapters, questionCount);
            
            // Initialize test state
            currentQuestionIndex = 0;
            userAnswers = new Array(testQuestions.length).fill(null);
            flaggedQuestions = [];
            testStartTime = Date.now();
            timeRemaining = timeLimit * 60; // Convert to seconds
            isPaused = false;

            // Show test interface
            document.getElementById('testSetup').classList.add('hidden');
            document.getElementById('testInterface').classList.remove('hidden');

            // Start timer if time limit is set
            if (timeLimit > 0) {
                startTimer();
            } else {
                document.getElementById('timerContainer').style.display = 'none';
            }

            // Load first question
            loadQuestion();
        }

        function prepareTestQuestions(chapters, count) {
            let allQuestions = [];
            
            // Get questions from selected chapters
            chapters.forEach(chapter => {
                const chapterQuestions = getQuestionsByChapter(chapter);
                allQuestions = allQuestions.concat(chapterQuestions.map(q => ({
                    ...q,
                    chapter: chapter,
                    chapterTitle: studyQuestions[chapter].title
                })));
            });

            // Shuffle questions
            allQuestions = shuffleArray(allQuestions);
            
            // Select the requested number of questions
            testQuestions = allQuestions.slice(0, Math.min(count, allQuestions.length));
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function startTimer() {
            updateTimerDisplay();
            testTimer = setInterval(() => {
                if (!isPaused) {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(testTimer);
                        finishTest();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeRemaining').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update timer ring
            const totalTime = parseInt(document.getElementById('timeLimit').value) * 60;
            const progress = (totalTime - timeRemaining) / totalTime;
            const offset = 283 - (progress * 283);
            document.getElementById('timerRing').style.strokeDashoffset = offset;
        }

        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play mr-1"></i> Resume';
                pauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                pauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause mr-1"></i> Pause';
                pauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                pauseBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        }

        function loadQuestion() {
            const question = testQuestions[currentQuestionIndex];
            
            // Update question info
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = testQuestions.length;
            document.getElementById('questionChapter').textContent = question.chapter.replace('chapter', 'Chapter ');
            document.getElementById('questionDifficulty').textContent = 
                question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);
            document.getElementById('questionDifficulty').className = 
                `text-xs font-semibold px-2 py-1 rounded-full ${getDifficultyColor(question.difficulty)}`;
            document.getElementById('questionText').textContent = question.question;
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / testQuestions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Generate multiple choice options
            generateOptions(question);
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('prevBtn').classList.toggle('opacity-50', currentQuestionIndex === 0);
            
            const nextBtn = document.getElementById('nextBtn');
            if (currentQuestionIndex === testQuestions.length - 1) {
                nextBtn.innerHTML = 'Finish Test <i class="fas fa-check ml-2"></i>';
                nextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                nextBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ml-2"></i>';
                nextBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            
            // Update flag button
            const flagBtn = document.getElementById('flagBtn');
            if (flaggedQuestions.includes(currentQuestionIndex)) {
                flagBtn.innerHTML = '<i class="fas fa-flag mr-2"></i> Unflag Question';
                flagBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                flagBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                flagBtn.innerHTML = '<i class="fas fa-flag mr-2"></i> Flag Question';
                flagBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                flagBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        }

        function generateOptions(correctQuestion) {
            const container = document.getElementById('optionsContainer');
            
            // Get other questions to create wrong answers
            const otherQuestions = testQuestions.filter((q, index) => index !== currentQuestionIndex);
            const wrongAnswers = shuffleArray(otherQuestions).slice(0, 3).map(q => q.answer);
            
            // Combine correct and wrong answers
            const allOptions = shuffleArray([correctQuestion.answer, ...wrongAnswers]);
            
            container.innerHTML = allOptions.map((option, index) => `
                <button class="option-button w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all" 
                        data-option="${option}" onclick="selectOption('${option}')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 text-sm font-semibold">
                            ${String.fromCharCode(65 + index)}
                        </div>
                        <span>${option}</span>
                    </div>
                </button>
            `).join('');
            
            // Restore previous selection
            if (userAnswers[currentQuestionIndex] !== null) {
                selectOption(userAnswers[currentQuestionIndex]);
            }
        }

        function selectOption(option) {
            // Clear previous selection
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('option-selected');
            });
            
            // Select new option
            const selectedBtn = document.querySelector(`[data-option="${option}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('option-selected');
                userAnswers[currentQuestionIndex] = option;
            }
        }

        function navigateQuestion(direction) {
            const newIndex = currentQuestionIndex + direction;
            
            if (newIndex < 0 || newIndex >= testQuestions.length) {
                if (newIndex >= testQuestions.length) {
                    finishTest();
                }
                return;
            }
            
            currentQuestionIndex = newIndex;
            loadQuestion();
        }

        function toggleFlag() {
            const index = flaggedQuestions.indexOf(currentQuestionIndex);
            
            if (index > -1) {
                flaggedQuestions.splice(index, 1);
            } else {
                flaggedQuestions.push(currentQuestionIndex);
            }
            
            loadQuestion(); // Refresh the flag button
        }

        function finishTest() {
            // Stop timer
            if (testTimer) {
                clearInterval(testTimer);
            }
            
            // Calculate results
            const results = calculateResults();
            
            // Show results
            displayResults(results);
            
            // Hide test interface
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('testResults').classList.remove('hidden');
        }

        function calculateResults() {
            let correctCount = 0;
            const chapterStats = {};
            
            testQuestions.forEach((question, index) => {
                const chapter = question.chapter;
                
                // Initialize chapter stats if needed
                if (!chapterStats[chapter]) {
                    chapterStats[chapter] = { total: 0, correct: 0 };
                }
                
                chapterStats[chapter].total++;
                
                if (userAnswers[index] === question.answer) {
                    correctCount++;
                    chapterStats[chapter].correct++;
                }
            });
            
            const totalTime = Date.now() - testStartTime;
            const score = Math.round((correctCount / testQuestions.length) * 100);
            
            return {
                score,
                correctCount,
                totalQuestions: testQuestions.length,
                timeTaken: totalTime,
                flaggedCount: flaggedQuestions.length,
                chapterStats
            };
        }

        function displayResults(results) {
            document.getElementById('finalScore').textContent = `${results.score}%`;
            document.getElementById('correctAnswers').textContent = results.correctCount;
            document.getElementById('totalAnswers').textContent = results.totalQuestions;
            
            const minutes = Math.floor(results.timeTaken / 60000);
            const seconds = Math.floor((results.timeTaken % 60000) / 1000);
            document.getElementById('timeTaken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('questionsFlagged').textContent = results.flaggedCount;
            
            const avgTime = Math.floor(results.timeTaken / results.totalQuestions / 1000);
            const avgMinutes = Math.floor(avgTime / 60);
            const avgSeconds = avgTime % 60;
            document.getElementById('avgTimePerQuestion').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            const letterGrade = getLetterGrade(results.score);
            document.getElementById('letterGrade').textContent = letterGrade;
            
            // Display chapter breakdown
            const breakdownContainer = document.getElementById('chapterBreakdown');
            breakdownContainer.innerHTML = Object.entries(results.chapterStats).map(([chapter, stats]) => {
                const percentage = Math.round((stats.correct / stats.total) * 100);
                const chapterName = studyQuestions[chapter].title.split(':')[0];
                return `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">${chapterName}:</span>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold">${stats.correct}/${stats.total} (${percentage}%)</span>
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getLetterGrade(score) {
            if (score >= 97) return 'A+';
            if (score >= 93) return 'A';
            if (score >= 90) return 'A-';
            if (score >= 87) return 'B+';
            if (score >= 83) return 'B';
            if (score >= 80) return 'B-';
            if (score >= 77) return 'C+';
            if (score >= 73) return 'C';
            if (score >= 70) return 'C-';
            if (score >= 67) return 'D+';
            if (score >= 63) return 'D';
            return 'F';
        }

        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case 'easy': return 'bg-green-100 text-green-800';
                case 'medium': return 'bg-yellow-100 text-yellow-800';
                case 'hard': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function reviewAnswers() {
            document.getElementById('testResults').classList.add('hidden');
            document.getElementById('reviewSection').classList.remove('hidden');
            
            const reviewContainer = document.getElementById('reviewContainer');
            reviewContainer.innerHTML = testQuestions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const isFlagged = flaggedQuestions.includes(index);
                
                return `
                    <div class="bg-white/50 rounded-xl p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                    Question ${index + 1}
                                </span>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${getDifficultyColor(question.difficulty)}">
                                    ${question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1)}
                                </span>
                                ${isFlagged ? '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-800"><i class="fas fa-flag mr-1"></i>Flagged</span>' : ''}
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${isCorrect ? '<i class="fas fa-check mr-1"></i>Correct' : '<i class="fas fa-times mr-1"></i>Incorrect'}
                                </span>
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">${question.question}</h3>
                        
                        <div class="space-y-2">
                            <div class="p-3 rounded-lg ${userAnswer === question.answer ? 'bg-green-100 border border-green-300' : 'bg-gray-100 border border-gray-300'}">
                                <div class="font-semibold text-green-800 mb-1">Correct Answer:</div>
                                <div class="text-gray-700">${question.answer}</div>
                            </div>
                            
                            ${!isCorrect ? `
                                <div class="p-3 rounded-lg bg-red-100 border border-red-300">
                                    <div class="font-semibold text-red-800 mb-1">Your Answer:</div>
                                    <div class="text-gray-700">${userAnswer || 'No answer selected'}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function backToResults() {
            document.getElementById('reviewSection').classList.add('hidden');
            document.getElementById('testResults').classList.remove('hidden');
        }

        function retakeTest() {
            // Reset test with same settings
            document.getElementById('testResults').classList.add('hidden');
            startTest();
        }

        function newTest() {
            // Go back to test setup
            document.getElementById('testResults').classList.add('hidden');
            document.getElementById('testSetup').classList.remove('hidden');
        }
    </script>
<script>
    document.addEventListener('keydown', e => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            e.preventDefault();
        }
    });
</script>
</body>
</html>